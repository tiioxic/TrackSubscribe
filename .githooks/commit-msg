#!/bin/bash

# Configuration
MIN_LENGTH=10
MAX_LENGTH=100
COMMIT_MSG_FILE=$1
# Lire la premi√®re ligne du fichier de message de commit
COMMIT_MSG=$(head -n 1 "$COMMIT_MSG_FILE")
# Extraire le type (ex: feat, fix)
TYPE=$(echo "$COMMIT_MSG" | grep -oE '^[a-z]+' | head -n 1)

# Couleurs pour le terminal
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Dictionnaire des types et emojis correspondants
declare -A EMOJIS
EMOJIS=(
    ["feat"]="‚ú®"
    ["fix"]="üêõ"
    ["fix(docker)"]="üê≥"
    ["docs"]="üìù"
    ["style"]="üé®"
    ["refactor"]="‚ôªÔ∏è"
    ["perf"]="‚ö°Ô∏è"
    ["test"]="üß™"
    ["build"]="üèóÔ∏è"
    ["ci"]="üë∑"
    ["chore"]="üîß"
    ["revert"]="‚è™"
)

# 1. V√©rification de la longueur du message
MSG_LEN=${#COMMIT_MSG}
if [ $MSG_LEN -lt $MIN_LENGTH ] || [ $MSG_LEN -gt $MAX_LENGTH ]; then
    echo -e "${RED}Erreur : La longueur du message ($MSG_LEN) doit √™tre comprise entre $MIN_LENGTH et $MAX_LENGTH caract√®res.${NC}"
    exit 1
fi

# 2. V√©rification du format Conventionnel (type: message ou type(scope): message)
if ! [[ "$COMMIT_MSG" =~ ^[a-z]+(\(.+\))?!?: ]]; then
    echo -e "${RED}Erreur : Le message ne respecte pas le format 'type: description' ou 'type(scope): description'.${NC}"
    echo -e "Types valides: ${!EMOJIS[@]}"
    exit 1
fi

# 3. Ajout de l'emoji si le type est reconnu
if [[ -n "${EMOJIS[$TYPE]}" ]]; then
    EMOJI="${EMOJIS[$TYPE]}"
    
    # V√©rifie si l'emoji est d√©j√† pr√©sent pour ne pas le dupliquer
    if [[ "$COMMIT_MSG" != *"$EMOJI"* ]]; then
        # On utilise sed pour modifier le fichier en place
        # Mod√®le: "‚ú® type: message"
        sed -i "1s/^/$EMOJI /" "$COMMIT_MSG_FILE"
        echo -e "${GREEN}Emoji $EMOJI ajout√© au commit '$TYPE'!${NC}"
    fi
else
    # Rejet strict si le type n'est pas dans la liste autoris√©e
    echo -e "${RED}Erreur : Type de commit '$TYPE' inconnu ou non autoris√©.${NC}"
    echo -e "${RED}Types autoris√©s uniquement : ${!EMOJIS[@]}${NC}"
    exit 1
fi

exit 0
